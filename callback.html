<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
<style>
    body { font-family: monospace; background: #222; color: #eee; margin: 10px; font-size: 14px; }
    #status { padding: 10px; border: 1px solid #555; border-radius: 4px; }
    .error { color: #f66; }
</style>
</head>
<body>
    <p id="status">Completing authentication...</p>
    <script>
    try {
        const statusEl = document.getElementById('status');
        const queryParams = new URLSearchParams(window.location.search);
        const code = queryParams.get('code');
        const error = queryParams.get('error');

        if (error) {
            throw new Error(`GitHub returned an error: ${error}`);
        }

        if (code) {
            statusEl.textContent = 'Auth code received. Exchanging for token...';
            const authServiceUrl = 'https://auth.strategycontent.agency/auth';

            fetch(authServiceUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Token exchange failed with status ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.token) {
                    statusEl.textContent = 'Token received! Sending to main window...';

                    if (window.opener && !window.opener.closed) {
                        const message = { type: 'github_auth_success', token: data.token };
                        window.opener.postMessage(message, window.location.origin);

                        setTimeout(() => { window.close(); }, 200);
                    } else {
                        throw new Error('Opener window not found. Cannot send token.');
                    }
                } else {
                    throw new Error('Proxy response did not contain a token.');
                }
            })
            .catch(err => {
                statusEl.textContent = `Error: ${err.message}`;
                statusEl.className = 'error';
                if (window.opener && !window.opener.closed) {
                    window.opener.postMessage({ type: 'github_auth_error', error: err.message }, window.location.origin);
                }
            });

        } else {
            throw new Error('Invalid callback: No authorization code found.');
        }
    } catch (e) {
        document.getElementById('status').textContent = `A fatal script error occurred: ${e.message}`;
        document.getElementById('status').className = 'error';
    }
    </script>
</body>
</html>
