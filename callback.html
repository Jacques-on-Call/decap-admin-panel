<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
</head>
<body>
    <p>Processing authentication... Please do not close this window.</p>
    <script>
        (function() {
            // Debugging: Log if the page is hidden prematurely
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    console.warn('Callback page is being hidden or closed.');
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            const errorDescription = urlParams.get('error_description');

            if (window.opener) {
                let targetUrl;
                if (error) {
                    targetUrl = `${window.location.origin}/#error=${error}&error_description=${encodeURIComponent(errorDescription || 'Unknown error')}`;
                } else if (code) {
                    targetUrl = `${window.location.origin}/#code=${code}`;
                } else {
                    targetUrl = `${window.location.origin}/#error=invalid_callback&error_description=No_code_or_error_received`;
                }

                // Add a short delay to ensure the browser has time to process the redirect
                // before the popup might be closed.
                setTimeout(() => {
                    // Use replace() to avoid adding the callback to the browser history
                    window.opener.location.replace(targetUrl);
                    window.close();
                }, 300);

            } else {
                document.body.textContent = 'Error: Could not find the main application window. Please close this window and try again.';
            }
        })();
    </script>
</body>
</html>
