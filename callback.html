<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
<style>
    body { font-family: monospace; background: #222; color: #eee; margin: 0; padding: 10px; }
    p { font-size: 16px; }
    .error { color: #f66; }
</style>
</head>
<body>
    <p id="status">Completing authentication...</p>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusEl = document.getElementById('status');
        const queryParams = new URLSearchParams(window.location.search);
        const code = queryParams.get('code');
        const error = queryParams.get('error');

        if (error) {
            statusEl.textContent = `Authentication Error: ${error}. Redirecting...`;
            statusEl.className = 'error';
            setTimeout(() => { window.location.href = '/'; }, 3000);
        } else if (code) {
            statusEl.textContent = 'Authentication code received. Exchanging for token...';
            const authServiceUrl = 'https://auth.strategycontent.agency/auth';

            fetch(authServiceUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Token exchange failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.token) {
                    statusEl.textContent = 'Token received successfully! Redirecting to editor...';
                    // Store the token and redirect to the main page.
                    localStorage.setItem('github_token', data.token);
                    window.location.href = '/';
                } else {
                    throw new Error('Proxy response did not contain a token.');
                }
            })
            .catch(err => {
                statusEl.textContent = `Error: ${err.message}. Redirecting...`;
                statusEl.className = 'error';
                setTimeout(() => { window.location.href = '/'; }, 3000);
            });

        } else {
            statusEl.textContent = 'Invalid callback: No code or error found. Redirecting...';
            statusEl.className = 'error';
            setTimeout(() => { window.location.href = '/'; }, 3000);
        }
    });
    </script>
</body>
</html>
