<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
<style>
    body { font-family: monospace; background: #222; color: #eee; margin: 0; padding: 0; }
    #debug-panel {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        padding: 10px;
        box-sizing: border-box;
    }
    #debug-output { height: 100%; overflow-y: scroll; font-size: 12px; }
    #debug-output div {
        border-bottom: 1px solid #333;
        padding: 2px 0;
        margin-bottom: 2px;
        word-break: break-all;
    }
    #debug-output .error { color: #f66; }
    #debug-output .success { color: #6f6; }
    #debug-output .info { color: #88f; }
</style>
</head>
<body>
    <div id="debug-panel">
        <div id="debug-output"></div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const debugOutput = document.getElementById('debug-output');
        function logToScreen(message, type = 'info') {
            console.log(`[CALLBACK|${type}]`, message);
            if (debugOutput) {
                const entry = document.createElement('div');
                entry.className = type;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugOutput.prepend(entry);
            }
        }

        logToScreen('Callback page loaded.', 'success');
        logToScreen(`Full URL: ${window.location.href}`);

        const sendMessage = (message) => {
            logToScreen(`Constructing message: ${message}`);
            if (window.opener && !window.opener.closed) {
                logToScreen('Opener window found. Sending message in 200ms...');
                setTimeout(() => {
                    window.opener.postMessage(message, window.location.origin);
                    logToScreen('Message sent. Closing window in 200ms...');
                    setTimeout(() => window.close(), 200);
                }, 200);
            } else {
                logToScreen('Opener window not found!', 'error');
            }
        };

        const queryParams = new URLSearchParams(window.location.search);
        const code = queryParams.get('code');
        const error = queryParams.get('error');

        logToScreen(`URL Query: ${queryParams.toString()}`);

        if (error) {
            logToScreen(`Received error from GitHub: ${error}`, 'error');
            sendMessage(`authorization:github:error:${JSON.stringify({ error: error })}`);
        } else if (code) {
            logToScreen(`Received auth code: ${code}`, 'success');
            logToScreen('Exchanging code for token via proxy...');

            const authServiceUrl = 'https://auth.strategycontent.agency/auth';

            fetch(authServiceUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: code })
            })
            .then(response => {
                logToScreen(`Proxy response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`Token exchange failed with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                logToScreen('Received data from proxy: ' + JSON.stringify(data));
                if (data.token) {
                    logToScreen('Token extracted successfully.', 'success');
                    const message = `authorization:github:success:${JSON.stringify({ token: data.token })}`;
                    sendMessage(message);
                } else {
                    throw new Error('Proxy response did not contain a token.');
                }
            })
            .catch(err => {
                logToScreen(`Token exchange failed: ${err.message}`, 'error');
                sendMessage(`authorization:github:error:${JSON.stringify({ error: 'token_exchange_failed', error_description: err.message })}`);
            });

        } else {
            logToScreen('No code or error found in URL.', 'error');
            sendMessage(`authorization:github:error:${JSON.stringify({ error: 'invalid_callback', error_description: 'Callback was called without an auth code or an error.' })}`);
        }
    });
    </script>
</body>
</html>
