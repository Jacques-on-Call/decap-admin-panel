<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Callback page loaded. Origin:', window.location.origin);

        const postSuccess = (token) => {
            const message = `authorization:github:success:${JSON.stringify({
                provider: 'github',
                token: token
            })}`;
            sendMessage(message);
        };

        const postError = (error, error_description) => {
            const message = `authorization:github:error:${JSON.stringify({
                error: error,
                error_description: error_description
            })}`;
            sendMessage(message);
        };

        const sendMessage = (message) => {
            console.log('Attempting to post message:', message);

            // We must have an opener to send a message to.
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage(message, window.location.origin);
                console.log('Message sent to opener. Closing window shortly...');

                // Add a small delay before closing to ensure the message is delivered.
                // 200ms is imperceptible to the user but an eternity for the browser.
                setTimeout(() => {
                    window.close();
                }, 200);

            } else {
                console.error('Could not find opener window. Cannot send auth token.');
                // Optionally, show an error to the user in the popup.
                document.body.innerHTML = '<h1>Error</h1><p>Could not connect back to the main editor window. Please close this window and try again.</p>';
            }
        };

        // The auth service might return params in the hash or query string.
        // Let's check both, starting with the hash as it's more common for SPAs.
        let params = new URLSearchParams(window.location.hash.substring(1));
        if (!params.has('access_token') && !params.has('error')) {
            params = new URLSearchParams(window.location.search);
        }

        const token = params.get('access_token');
        const error = params.get('error');
        const errorDescription = params.get('error_description');

        if (token) {
            console.log('Token found. Preparing to send success message.');
            postSuccess(token);
        } else if (error) {
            console.error('Authentication error found:', error, errorDescription);
            postError(error, errorDescription);
        } else {
            console.error('No token or error found in URL. This is unexpected.');
            // Optional: You could post a generic error back to the main window.
            postError('unknown_error', 'The authentication provider did not return a token or an error.');
        }
    });
    </script>
</head>
<body>
    <p>Completing authentication... Please wait.</p>
</body>
</html>
