<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Authentication Callback</title>
<style>
    body { font-family: monospace; background: #222; color: #eee; margin: 0; padding: 0; }
    #debug-panel {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        padding: 10px;
        box-sizing: border-box;
    }
    #debug-output { height: 100%; overflow-y: scroll; font-size: 12px; }
    #debug-output div {
        border-bottom: 1px solid #333;
        padding: 2px 0;
        margin-bottom: 2px;
        word-break: break-all;
    }
    #debug-output .error { color: #f66; }
    #debug-output .success { color: #6f6; }
</style>
</head>
<body>
    <div id="debug-panel">
        <div id="debug-output"></div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const debugOutput = document.getElementById('debug-output');
        function logToScreen(message, type = 'info') {
            console.log(`[CALLBACK|${type}]`, message);
            if (debugOutput) {
                const entry = document.createElement('div');
                entry.className = type;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugOutput.prepend(entry);
            }
        }

        logToScreen('Callback page loaded.');
        logToScreen(`Full URL: ${window.location.href}`);

        const sendMessage = (message) => {
            logToScreen(`Constructed message: ${message}`);
            if (window.opener && !window.opener.closed) {
                logToScreen('Opener window found. Sending message in 200ms...');
                setTimeout(() => {
                    window.opener.postMessage(message, window.location.origin);
                    logToScreen('Message sent. Closing window in 200ms...');
                    setTimeout(() => window.close(), 200);
                }, 200);
            } else {
                logToScreen('Opener window not found!', 'error');
            }
        };

        const postSuccess = (token) => {
            const message = `authorization:github:success:${JSON.stringify({ token: token })}`;
            sendMessage(message);
        };

        const postError = (error, error_description) => {
            const message = `authorization:github:error:${JSON.stringify({ error, error_description })}`;
            sendMessage(message);
        };

        // The auth proxy should return the token in the URL hash.
        const params = new URLSearchParams(window.location.hash.substring(1));
        const token = params.get('access_token') || params.get('token');
        const error = params.get('error');
        const errorDescription = params.get('error_description');

        logToScreen(`URL Hash: ${window.location.hash}`);

        if (token) {
            logToScreen('Token found in URL hash.', 'success');
            postSuccess(token);
        } else if (error) {
            logToScreen(`Error found in URL hash: ${error}`, 'error');
            postError(error, errorDescription);
        } else {
            logToScreen('No token or error found in URL hash.', 'error');
            postError('invalid_callback', 'Callback page was reached but no token or error was found in the URL hash.');
        }
    });
    </script>
</body>
</html>
